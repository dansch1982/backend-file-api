<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style/style.css">
    <title>Dashboard</title>
</head>

<body>
    <section class="container">

        <section class="options">
            <button class="get">GET</button>
            <button class="post">POST</button>
            <button class="put">PUT</button>
            <button class="delete">DELETE</button>
        </section>

        <section class="display">
            <input class="url" value="http://127.0.0.1:8080/fruits">
            <article class="structure">Waiting for command<span class="dot">.</span></article>
            <textarea class="input" placeholder='{&#10;&emsp;"input" : "data"&#10;}'></textarea>
            <article class="response">Waiting for command<span class="dot">.</span></article>
        </section>
    </section>
    <script>
        const dotInterval = setInterval(() => {
            const dots = document.querySelectorAll('.dot')
            if (dots.length > 0) {
                dots.forEach(dot => {
                    dot.textContent = dot.textContent === "..." ? "." : dot.textContent + "."
                })
            } else {
                clearInterval(dotInterval)
            }
        }, 500);

        const get = document.querySelector('.get')
        get.addEventListener('click', async () => {
            const url = document.querySelector('.url')
            let data, json
            try {
                data = await (await fetch(url.value)).json()
                json = JSON.stringify(data)
            } catch (error) {
                json = error
            }

            function formatJSON(json) {

                function tabifyJSON(json) {
                    let array;
                    try {
                        array = splitJSON(json)
                    } catch (error) {
                        console.log(error)
                        return json
                    }
                    let i = 0;
                    array.forEach((item, index) => {
                        if (item.endsWith("{") || item.endsWith("[")) {
                            i++
                        } else if (item.startsWith("}") || item.startsWith("]")) {
                            i--
                        }
                        array[index] =
                            `<span style="margin-left: ${i - (array[index].endsWith("{") || array[index].endsWith("[")  ? 1 : 0)}rem">` +
                            array[index] + "</span>"
                    })

                    return array.join('<br>')
                }

                function splitJSON(json) {
                    const array = splitKeep(json, "{", "}", ",")

                    function splitKeep(element, ...string) {
                        let newArray;
                        for (let i = 0; i < string.length; i++) {
                            const exp = `(${string[i]})`
                            const regexp = new RegExp(exp, "g")
                            if (typeof element === "string") {
                                newArray = element.split(regexp).filter(Boolean)
                            } else if (Array.isArray(element)) {
                                newArray = []
                                element.forEach((item, index) => {
                                    if (item.indexOf(string[i]) >= 0) {
                                        newArray.push(...item.split(regexp).filter(Boolean))
                                    } else {
                                        newArray.push(item)
                                    }
                                })
                            } else {
                                throw "error: Can't split element."
                            }
                            element = newArray;
                        }
                        console.log(newArray)
                        return newArray
                    }

                    array.forEach((item, index) => {
                        if (item.startsWith(",")) {
                            array[index - 1] += item
                            array[index] = ""
                        }
                        if (item.endsWith(":")) {
                            array[index] = item + " " + array.splice(index + 1, 1)
                        }
                    })
                    return array.filter(Boolean)
                }

                return tabifyJSON(json)

            }

            const html = formatJSON(json)

            const response = document.querySelector('.response')
            const structure = document.querySelector('.structure')
            if (!data || data.error) {
                updateTerminal(response, html)
            } else {
                updateTerminal(structure, html)
                updateTerminal(response, "Success!")
            }
        })

        const url = document.querySelector('.url')
        url.addEventListener('keydown', () => {
            if (event.key.toLowerCase() === "enter") {
                get.click()
            }
        })

        function updateTerminal(terminal, html) {
            terminal.innerHTML = html
            terminal.classList.toggle('textBlack')
            setTimeout(() => {
                terminal.classList.toggle('textBlack')
            }, 200);
        }
    </script>
</body>

</html>